```{r}
#| message: false
#| warning: false
#| eval: false
# To clean data
library(tidyverse)
library(janitor)

# To scrape data
library(rvest)
library(httr)
library(polite)

# To visualize data
library(ggplot2)
library(showtext)
library(treemapify)

font_add_google("Abril Fatface", "abril-fatface")
font_add_google("Lato", "lato")

showtext::showtext_auto()
```


```{r}
#| eval: false
url <-
  "https://en.wikipedia.org/wiki/List_of_Taylor_Swift_live_performances"

url_bow <- polite::bow(url)
url_bow

ind_html <-
  polite::scrape(url_bow) |>  # <1>
  rvest::html_nodes("table.wikitable") |> # <2>
  rvest::html_table(fill = TRUE) 

ind_tab <- 
  ind_html[[1]] |> 
  janitor::clean_names() |> 
  dplyr::mutate(across(
    c(adjusted_gross_in_2023_dollar,
      gross,
      attendance),
    ~ as.numeric(str_replace_all(.x, "[$,]", ""))
  )) |> 
  dplyr::mutate(attendance = case_when(title == "The Eras Tour" ~ 10512000,
                                       .default = attendance),
                gross = case_when(title == "The Eras Tour" ~ 2200000000,
                                       .default = gross),
                adjusted_gross_in_2023_dollar = case_when(title == "The Eras Tour" ~ 2200000000,
                                       .default = adjusted_gross_in_2023_dollar),
                label = paste0(title, "<br><span style='font-size:30pt'>", scales::dollar(adjusted_gross_in_2023_dollar), "</span>"),
                image = case_when(title == "The Eras Tour" ~ "<img src='notebooks/logo-images/eras.png'>",
                                  title == "Fearless Tour" ~ "<img src='notebooks/logo-images/fearless.png' style='width:30%'>",
                                  title == "The 1989 World Tour" ~ "<img src='notebooks/logo-images/1989.png'>",
                                  title == "Reputation Stadium Tour" ~ "<img src='notebooks/logo-images/reputation.png'>",
                                  title == "Speak Now World Tour" ~ "<img src='notebooks/logo-images/speak_now.jpg'>",
                                  title == "The Red Tour" ~ "<img src='notebooks/logo-images/red.jpg'>")) %>%
  mutate(image = paste0(image, "<br><span style='font-size:30pt'>", scales::dollar(adjusted_gross_in_2023_dollar), "</span>")) %>% 
  mutate(adjusted_gross_in_2023_dollar2 = case_when(title == "Fearless Tour" ~ adjusted_gross_in_2023_dollar * 1.5,
                                                   .default = adjusted_gross_in_2023_dollar))

treemap <-
  treemapify(ind_tab, area = "adjusted_gross_in_2023_dollar")

treemap <-
  left_join(ind_tab, treemap |> select(title, ymax:xmax))

total <- sum(ind_tab$adjusted_gross_in_2023_dollar)

# https://github.com/wilkox/treemapify/issues/37
treemap |>
  ggplot(
    aes(
      area = adjusted_gross_in_2023_dollar2,
      fill = title,
      label = paste(title, scales::dollar(adjusted_gross_in_2023_dollar), sep = "\n")
    )
  ) +
  geom_treemap() +
  geom_treemap_text(
    colour = "#1D1E3C",
    place = "center",
    grow = TRUE,
    reflow = FALSE,
    family = "abril-fatface"
  ) +
  # ggfittext::geom_fit_text(
  #   family = "abril-fatface",
  #   color = "white",
  #   place = "center",
  #   grow = FALSE,
  #   rich = TRUE,
  #   contrast = TRUE
  # ) +
  labs(title = scales::dollar(total)) +
  theme_void() +
  theme(
    legend.position = "none",
    plot.title = element_text(
      size = 70,
      family = "abril-fatface",
      hjust = 0.5,
      color = "#1D1E3C"
    )
  ) +
  scale_fill_manual(values = c("#b9d2b5",
                               "#f4cb8d",
                               "#b5e9f6",
                               "#d1b2d2",
                               "#CFCAC6",
                               "#C8AE95")) -> taylor_treemap

save(taylor_treemap, file = "images/taylor_treemap.rdata")
```
